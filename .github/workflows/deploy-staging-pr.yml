name: 'deploy'
on:
  pull_request:
    branches:
      - staging
jobs:
  review_app:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Cloning repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Push to dokku
        uses: dokku/github-action@master
        env:
          GIT_SSH_COMMAND: 'ssh -vvv'        
        with:
          command: review-apps:create
          git_push_flags: '--force -vvv'
          git_remote_url: 'ssh://dokku@dokku.steercampaign.com/${{ secrets.DOKKU_STAGING_APP_NAME }}'
          review_app_name: review-appname-${{ github.event.pull_request.number }}
          ssh_private_key: ${{ secrets.DOKKU_KEY }}
  destroy_review_app:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - name: Destroy the review app
        uses: dokku/github-action@master
        env:
          GIT_SSH_COMMAND: 'ssh -vvv'        
        with:
          command: review-apps:destroy
          git_push_flags: '--force -vvv'
          git_remote_url: 'ssh://dokku@dokku.steercampaign.com/${{ secrets.DOKKU_STAGING_APP_NAME }}'
          review_app_name: review-appname-${{ github.event.pull_request.number }}
          ssh_private_key: ${{ secrets.DOKKU_KEY }}